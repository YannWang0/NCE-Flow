<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="NCE Flow">
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="manifest" href="manifest.json">
  <title>NCE Flow</title>
  <link rel="stylesheet" href="assets/styles.css">
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "tvjv632zgs");
</script>
  <script src="assets/app.js" defer></script>
  <script src="assets/lesson.js" defer></script>

  <!-- 主题切换逻辑 - 使用 class-based 方法，与 mibiao.html 相同 -->
  <script>
    (function() {
      if (!window.matchMedia) return;

      const colorSchemeQuery = window.matchMedia('(prefers-color-scheme: dark)');

      const applyTheme = function(isDark) {
        if (!document.body) return;

        // 移除所有主题 class
        document.body.classList.remove('dark-theme', 'light-theme');

        // 添加对应的主题 class
        if (isDark) {
          document.body.classList.add('dark-theme');
        } else {
          document.body.classList.add('light-theme');
        }

        // 强制浏览器重绘
        const originalDisplay = document.body.style.display;
        document.body.style.display = 'none';
        void document.body.offsetHeight;
        document.body.style.display = originalDisplay;

        document.body.style.transform = 'translateZ(0)';
        setTimeout(() => {
          document.body.style.transform = '';
        }, 0);
      };

      const handleChange = function(e) {
        applyTheme(e.matches);
      };

      // 注册监听器
      if (colorSchemeQuery.addEventListener) {
        colorSchemeQuery.addEventListener('change', handleChange);
      } else if (colorSchemeQuery.addListener) {
        colorSchemeQuery.addListener(handleChange);
      }

      // 等待 DOM 加载后立即应用主题
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          applyTheme(colorSchemeQuery.matches);
        });
      } else {
        applyTheme(colorSchemeQuery.matches);
      }
    })();
  </script>
</head>
<body class="lesson-page">
  <canvas id="bg-canvas"></canvas>
	  <div class="container">
	    <header class="hero">
	      <h1 id="lessonTitle">课文</h1>
	      <p id="lessonSub" class="muted"></p>
	    </header>
	    <div class="toolbar">
	      <div class="topbar-inner">
		        <a id="backLink" class="back-inline" href="#" aria-label="首页">
		          <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false"><path fill="currentColor" d="M9.78 3.22a.75.75 0 0 1 0 1.06L6.06 8l3.72 3.72a.75.75 0 1 1-1.06 1.06L4.47 8.53a1.25 1.25 0 0 1 0-1.77l4.25-4.25a.75.75 0 0 1 1.06 0Z"></path></svg>
		          首页
		        </a>
	        <div class="seg-wrap">
	          <div id="langTabs" class="segmented tabs" role="tablist" aria-label="语言">
	            <button class="seg" data-mode="en">EN</button>
	            <button class="seg" data-mode="bi">EN+CN</button>
	            <button class="seg" data-mode="cn">CN</button>
	          </div>
	        </div>
	        <button id="settingsBtn" class="back-inline" aria-label="设置" title="设置">
	          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
	            <path d="M9.59356 3.94014C9.68397 3.39768 10.1533 3.00009 10.7033 3.00009H13.2972C13.8472 3.00009 14.3165 3.39768 14.4069 3.94014L14.6204 5.22119C14.6828 5.59523 14.9327 5.9068 15.2645 6.09045C15.3387 6.13151 15.412 6.17393 15.4844 6.21766C15.8095 6.41393 16.2048 6.47495 16.5604 6.34175L17.7772 5.88587C18.2922 5.69293 18.8712 5.9006 19.1462 6.37687L20.4432 8.6233C20.7181 9.09957 20.6085 9.70482 20.1839 10.0544L19.1795 10.8812C18.887 11.122 18.742 11.4938 18.7491 11.8726C18.7498 11.915 18.7502 11.9575 18.7502 12.0001C18.7502 12.0427 18.7498 12.0852 18.7491 12.1275C18.742 12.5064 18.887 12.8782 19.1795 13.119L20.1839 13.9458C20.6085 14.2953 20.7181 14.9006 20.4432 15.3769L19.1462 17.6233C18.8712 18.0996 18.2922 18.3072 17.7772 18.1143L16.5604 17.6584C16.2048 17.5252 15.8095 17.5862 15.4844 17.7825C15.412 17.8263 15.3387 17.8687 15.2645 17.9097C14.9327 18.0934 14.6828 18.4049 14.6204 18.779L14.4069 20.06C14.3165 20.6025 13.8472 21.0001 13.2972 21.0001H10.7033C10.1533 21.0001 9.68397 20.6025 9.59356 20.06L9.38005 18.779C9.31771 18.4049 9.06774 18.0934 8.73597 17.9097C8.66179 17.8687 8.58847 17.8263 8.51604 17.7825C8.19101 17.5863 7.79568 17.5252 7.44011 17.6584L6.22325 18.1143C5.70826 18.3072 5.12926 18.0996 4.85429 17.6233L3.55731 15.3769C3.28234 14.9006 3.39199 14.2954 3.81657 13.9458L4.82092 13.119C5.11343 12.8782 5.25843 12.5064 5.25141 12.1276C5.25063 12.0852 5.25023 12.0427 5.25023 12.0001C5.25023 11.9575 5.25063 11.915 5.25141 11.8726C5.25843 11.4938 5.11343 11.122 4.82092 10.8812L3.81657 10.0544C3.39199 9.70484 3.28234 9.09958 3.55731 8.62332L4.85429 6.37688C5.12926 5.90061 5.70825 5.69295 6.22325 5.88588L7.4401 6.34176C7.79566 6.47496 8.19099 6.41394 8.51603 6.21767C8.58846 6.17393 8.66179 6.13151 8.73597 6.09045C9.06774 5.9068 9.31771 5.59523 9.38005 5.22119L9.59356 3.94014Z"></path>
	            <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3432 10.3431 9.00001 12 9.00001C13.6569 9.00001 15 10.3432 15 12Z"></path>
	          </svg>
	          设置
	        </button>
	      </div>
	    </div>
	    <main class="sentences" id="sentences"></main>
	    <div class="lesson-nav">
	      <a id="prevLesson" class="btn-nav prev" href="#">上一课</a>
	      <a id="nextLesson" class="btn-nav next" href="#">下一课</a>
	    </div>
	    <!-- Bottom player bar -->
	    <div class="bottom-player-bar" role="region" aria-label="播放器">
	      <div class="player">
	        <div class="custom-player">
	          <audio id="player"></audio>
	          <button id="playPauseBtn" class="play-btn" aria-label="播放/暂停">
	            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
	              <path d="M8 5v14l11-7z"/>
	            </svg>
	            <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none">
	              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
	            </svg>
	          </button>
	          <div class="time-display" id="currentTime">0:00</div>
	          <div class="progress-container">
	            <div class="progress-bar" id="progressBar">
	              <div class="progress-filled" id="progressFilled"></div>
	            </div>
	          </div>
	          <div class="time-display" id="duration">0:00</div>
	        </div>
	      </div>
	    </div>
	    <footer>
	      <p class="repo">
	        <a class="gh-link" href="https://github.com/luzhenhua/NCE-Flow" target="_blank" rel="noopener" aria-label="GitHub repository">
	          <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36 .09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8Z"></path></svg>
	        </a>
	      </p>
	      <p class="byline">Designed &amp; Maintained by <a href="https://luzhenhua.cn/" target="_blank" rel="noopener">Luzhenhua</a></p>
	      <p class="thanks">Thanks to iChochy</p>
		      <p class="version"><a href="https://github.com/luzhenhua/NCE-Flow/releases" target="_blank" rel="noopener">v1.6.0</a><span id="pwaFooterInstall" class="pwa-footer-link" hidden> · <a href="#">安装应用</a></span></p>
	      <p class="byline" style="margin-top:12px;font-size:13px;opacity:0.7">Translation enhanced by AI · <a href="https://github.com/luzhenhua/NCE-Flow/issues" target="_blank" rel="noopener">Feedback</a></p>
    </footer>
  </div>
  <!-- Settings Overlay/Panel -->
  <div id="settingsOverlay" class="settings-overlay" hidden></div>
  <div id="settingsPanel" class="settings-panel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" hidden>
    <div class="settings-header">
      <h2 id="settingsTitle">设置</h2>
      <button id="settingsClose" class="icon-btn" aria-label="关闭设置" title="关闭">
        <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
          <path d="M5 5 L15 15 M15 5 L5 15"></path>
        </svg>
      </button>
    </div>
    <div class="settings-body">
      <div class="settings-group">
        <div class="settings-left">
          <div class="settings-label">播放速度</div>
          <div class="settings-desc">点击切换常用倍速，自动记住你的选择。</div>
        </div>
        <div class="settings-control">
          <button id="speed" class="back-inline" aria-label="速度">速度</button>
        </div>
      </div>
          <div class="settings-group full-width">
            <div class="settings-header-row">
              <div class="settings-label">阅读模式</div>
            </div>
            <div class="read-mode-options" role="radiogroup" aria-label="阅读模式">
              <label class="mode-option">
                <input type="radio" id="readModeContinuous" name="readMode" value="continuous" checked>
                <div class="mode-card-inner">
                  <div class="mode-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                  </div>
                  <div class="mode-info">
                    <div class="mode-name">连读</div>
                    <div class="mode-detail">自动播放下一句</div>
                  </div>
                </div>
              </label>
              
              <label class="mode-option">
                <input type="radio" id="readModeSingle" name="readMode" value="single">
                <div class="mode-card-inner">
                  <div class="mode-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>
                  </div>
                  <div class="mode-info">
                    <div class="mode-name">点读</div>
                    <div class="mode-detail">只播放点击句子</div>
                  </div>
                </div>
              </label>

              <label class="mode-option">
                <input type="radio" id="readModeListen" name="readMode" value="listen">
                <div class="mode-card-inner">
                  <div class="mode-icon">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                  </div>
                  <div class="mode-info">
                    <div class="mode-name">听读</div>
                    <div class="mode-detail">遮盖句子纯听力</div>
                  </div>
                </div>
              </label>

              <label class="mode-option">
                <input type="radio" id="readModeShadow" name="readMode" value="shadow">
                <div class="mode-card-inner">
                  <div class="mode-icon">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                  </div>
                  <div class="mode-info">
                    <div class="mode-name">跟读</div>
                    <div class="mode-detail">单句循环自动续句</div>
                  </div>
                </div>
              </label>
            </div>
          </div>
          <div class="settings-group" id="shadowSettingsGroup">
            <div class="settings-left">
              <div class="settings-label">跟读设置</div>
              <div class="settings-desc">单句循环次数与跟读间隔倍率设置。</div>
            </div>
            <div class="settings-control shadow-controls">
              <div class="shadow-repeat">
                <label class="shadow-label" for="shadowRepeat">循环</label>
                <input id="shadowRepeat" class="shadow-number" type="number" min="1" max="9" step="1" inputmode="numeric" pattern="[0-9]*" value="2" aria-label="跟读循环次数">
                <span class="shadow-unit">遍</span>
              </div>
              <div id="shadowGapCard" class="auto-continue-card" role="radiogroup" aria-label="跟读间隔">
                <div class="auto-continue-option">
                  <input type="radio" id="shadowGapShort" name="shadowGap" value="short">
                  <label for="shadowGapShort">短</label>
                </div>
                <div class="auto-continue-option">
                  <input type="radio" id="shadowGapMedium" name="shadowGap" value="medium">
                  <label for="shadowGapMedium">中</label>
                </div>
                <div class="auto-continue-option">
                  <input type="radio" id="shadowGapLong" name="shadowGap" value="long">
                  <label for="shadowGapLong">长</label>
                </div>
              </div>
            </div>
          </div>
      <div class="settings-group">
        <div class="settings-left">
          <div class="settings-label">播完后</div>
          <div class="settings-desc">播放结束后的行为设置。</div>
        </div>
        <div class="settings-control">
          <div id="afterPlayCard" class="auto-continue-card" role="radiogroup" aria-label="播完后">
            <div class="auto-continue-option">
              <input type="radio" id="afterPlaySingle" name="afterPlay" value="single">
              <label for="afterPlaySingle">单句循环</label>
            </div>
            <div class="auto-continue-option">
              <input type="radio" id="afterPlayAll" name="afterPlay" value="all">
              <label for="afterPlayAll">整篇循环</label>
            </div>
            <div class="auto-continue-option">
              <input type="radio" id="afterPlayNext" name="afterPlay" value="next">
              <label for="afterPlayNext">自动续集</label>
            </div>
            <div class="auto-continue-option">
              <input type="radio" id="afterPlayNone" name="afterPlay" value="none" checked>
              <label for="afterPlayNone">结束播放</label>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-left">
          <div class="settings-label">自动跟随</div>
          <div class="settings-desc">播放时自动滚动定位到当前句子；关闭后不自动滚动。</div>
        </div>
        <div class="settings-control">
          <div id="followCard" class="auto-continue-card" role="radiogroup" aria-label="自动跟随">
            <div class="auto-continue-option">
              <input type="radio" id="followOn" name="autoFollow" value="true" checked>
              <label for="followOn">跟随</label>
            </div>
            <div class="auto-continue-option">
              <input type="radio" id="followOff" name="autoFollow" value="false">
              <label for="followOff">不跟随</label>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-left">
          <div class="settings-label">跳过开头</div>
          <div class="settings-desc">智能跳过课程标题和提示问题，直接开始正文学习。</div>
        </div>
        <div class="settings-control">
          <div id="skipIntroCard" class="auto-continue-card" role="radiogroup" aria-label="跳过开头">
            <div class="auto-continue-option">
              <input type="radio" id="skipIntroOn" name="skipIntro" value="true">
              <label for="skipIntroOn">开启</label>
            </div>
            <div class="auto-continue-option">
              <input type="radio" id="skipIntroOff" name="skipIntro" value="false" checked>
              <label for="skipIntroOff">关闭</label>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-group">
        <div class="settings-left">
          <div class="settings-label">快捷键</div>
          <div class="settings-desc">使用键盘快捷键提升学习效率。</div>
        </div>
        <div class="settings-control">
          <button id="shortcutsToggle" class="back-inline" aria-label="快捷键帮助">查看</button>
        </div>
      </div>
    </div>
    <div class="settings-footer">
      <button id="settingsReset" class="btn">恢复默认</button>
      <button id="settingsDone" class="btn-nav">完成</button>
    </div>
  </div>

  <!-- Shortcuts Help Panel -->
  <div id="shortcutsOverlay" class="settings-overlay" hidden></div>
  <div id="shortcutsPanel" class="settings-panel shortcuts-panel" role="dialog" aria-modal="true" aria-labelledby="shortcutsTitle" hidden>
    <div class="settings-header">
      <h2 id="shortcutsTitle">快捷键</h2>
      <button id="shortcutsClose" class="icon-btn" aria-label="关闭快捷键帮助" title="关闭">
        <svg viewBox="0 0 20 20" aria-hidden="true" focusable="false" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round">
          <path d="M5 5 L15 15 M15 5 L5 15"></path>
        </svg>
      </button>
    </div>
    <div class="settings-body">
      <div class="shortcuts-group">
        <h3>播放控制</h3>
        <div class="shortcut-item">
          <kbd>Space</kbd>
          <span>播放 / 暂停</span>
        </div>
        <div class="shortcut-item">
          <kbd>R</kbd>
          <span>重播当前句</span>
        </div>
      </div>
      <div class="shortcuts-group">
        <h3>句子导航</h3>
        <div class="shortcut-item">
          <kbd>→</kbd> 或 <kbd>D</kbd>
          <span>下一句</span>
        </div>
        <div class="shortcut-item">
          <kbd>←</kbd> 或 <kbd>A</kbd>
          <span>上一句</span>
        </div>
      </div>
      <div class="shortcuts-group">
        <h3>音量控制</h3>
        <div class="shortcut-item">
          <kbd>↑</kbd>
          <span>增加音量</span>
        </div>
        <div class="shortcut-item">
          <kbd>↓</kbd>
          <span>减少音量</span>
        </div>
      </div>
      <div class="shortcuts-group">
        <h3>听读模式</h3>
        <div class="shortcut-item">
          <kbd>点击按钮</kbd>
          <span>显示/隐藏文本</span>
        </div>
        <div class="shortcut-item">
          <kbd>V</kbd>
          <span>显示/隐藏当前句</span>
        </div>
      </div>
    </div>
    <div class="settings-footer">
      <button id="shortcutsBack" class="btn">返回设置</button>
      <button id="shortcutsDone" class="btn-nav">完成</button>
    </div>
  </div>
  <script>
    // 注册 Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('[PWA] Service Worker 注册成功'))
          .catch(err => console.log('[PWA] Service Worker 注册失败:', err));
      });
    }
  </script>

  <!-- PWA Install Prompt -->
  <div id="pwaPrompt" class="pwa-prompt">
    <img src="icons/icon-192x192.png" alt="" class="pwa-prompt-icon">
    <div class="pwa-prompt-content">
      <span class="pwa-prompt-title">安装 NCE Flow</span>
      <span class="pwa-prompt-sub" id="pwaPromptSub">添加到主屏幕，随时学习</span>
    </div>
    <button id="pwaInstall" class="pwa-prompt-btn">安装</button>
    <span id="pwaClose" class="pwa-prompt-close">×</span>
  </div>
  <!-- Back to top -->
  <button id="backToTop" class="back-to-top" type="button" aria-label="回到顶端" title="回到顶端">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 5v14"></path>
      <polyline points="6 11 12 5 18 11"></polyline>
    </svg>
  </button>
  <script>
    (function() {
      const DISMISS_KEY = 'pwa_dismissed';
      const INSTALLED_KEY = 'pwa_installed';
      let deferredPrompt = null;
      const el = document.getElementById('pwaPrompt');
      const installBtn = document.getElementById('pwaInstall');
      const closeBtn = document.getElementById('pwaClose');
      const promptSub = document.getElementById('pwaPromptSub');
      const footerInstall = document.getElementById('pwaFooterInstall');
      if (!el) return;

      // 检测 iOS Safari
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome|CriOS|FxiOS/.test(navigator.userAgent);
      const isIOSSafari = isIOS && isSafari;
      const isStandalone = window.matchMedia('(display-mode:standalone)').matches || navigator.standalone;

      const isInstalled = () => isStandalone || localStorage.getItem(INSTALLED_KEY);
      const isDismissed = () => { const d = localStorage.getItem(DISMISS_KEY); return d && (Date.now() - parseInt(d)) < 7*24*60*60*1000; };

      const showPrompt = () => {
        if (isInstalled() || isDismissed()) return;
        if (!deferredPrompt && !isIOSSafari) return;
        el.classList.add('show');
      };
      const hidePrompt = () => el.classList.remove('show');
      const showFooterLink = () => { if (footerInstall && !isInstalled()) footerInstall.hidden = false; };
      const hideFooterLink = () => { if (footerInstall) footerInstall.hidden = true; };

      // iOS 引导界面
      const showIOSGuide = () => {
        el.classList.add('ios-prompt');
        promptSub.innerHTML = '点击底部 <svg class="ios-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> 然后选择「添加到主屏幕」';
        installBtn.textContent = '知道了';
        installBtn.onclick = hidePrompt;
      };

      const doInstall = async () => {
        // iOS Safari: 点击后显示引导
        if (isIOSSafari) {
          showIOSGuide();
          return;
        }
        // Chrome/Edge: 标准安装流程
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const {outcome} = await deferredPrompt.userChoice;
        if (outcome === 'accepted') localStorage.setItem(INSTALLED_KEY, '1');
        deferredPrompt = null;
        hidePrompt();
        hideFooterLink();
      };

      // iOS Safari: 延迟显示提示（与 Android 相同的初始界面）
      if (isIOSSafari && !isInstalled() && !isDismissed()) {
        showFooterLink();
        setTimeout(showPrompt, 2500);
      }

      // Chrome/Edge: 标准安装流程
      window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredPrompt = e;
        showFooterLink();
        setTimeout(showPrompt, 2500);
      });

      installBtn.addEventListener('click', doInstall);
      if (footerInstall) {
        footerInstall.querySelector('a').addEventListener('click', e => {
          e.preventDefault();
          showPrompt();
        });
      }
      closeBtn.addEventListener('click', () => { localStorage.setItem(DISMISS_KEY, Date.now()); hidePrompt(); });
      window.addEventListener('appinstalled', () => { localStorage.setItem(INSTALLED_KEY, '1'); hidePrompt(); hideFooterLink(); });
    })();
  </script>
</body>
</html>
